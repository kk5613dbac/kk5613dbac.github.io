<!DOCTYPE HTML>
<html lang="ja-JP">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<title>カードコンポーネントによるアコーディオン(Ver.4系)</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/popper.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="test180404_2_1018custom.js"></script>

<script>

var testArray1 = [
  ["みずほ普通（札幌）", 492132],
  ["みずほ普通（辻堂）", 0],
  ["みずほ定期（札幌）", 3000],
  ["みずほ積立（札幌）", -10000],
  ["現金", 210]
];

document.addEventListener('DOMContentLoaded', function(){
detectBrowserType();
/* makeTableをコールバックにしないと取得したJSONオブジェクトを以下の処理へ渡せない */
makeTable(function () {
total = 0;
for (var i=0; i<parsedArray.length; i++) {
  $('.accordion #target').append("<div id='#target'></div>");
  $('.accordion #target div').eq(i).attr('id', 'target' + String(i+1));
  $('.accordion #target div').eq(i).attr('data-deleted', 'false');
  $('.accordion #target div').eq(i).attr('data-modified', 'false');
  $('.accordion #target' + String(i+1)).load('template_1017.html', null,
    /* クロージャーでラッピングしないとカウンターの制御がうまくいかない */
    /* →　コールバックの外側が回りきってから内側が実行される */
    (function(i) {
      return function(response, status) {
        $(this).children('.card').attr('data-paymentsId', parsedArray[i][0]);
        $(this).find('.card-header').attr('id', 'heading' + String(i+1));
        $(this).find('.collapse').attr('aria-labelledby', 'heading' + String(i+1));
        $(this).find('.text-body').attr('href', '#collapse' + String(i+1));
        $(this).find('.text-body').attr('aria-controls', 'collapse' + String(i+1));
        $(this).find('.collapse').attr('id', 'collapse' + String(i+1));
        $(this).find('.card-header td').eq(0).text(parsedArray[i][1].substring(0, parsedArray[i][1].indexOf(' ')).replace(/-/g, '/'));
        $(this).find('.card-header td').eq(1).text(parsedArray[i][3]);
        if ((parsedArray[i][4] >= 0) && (parsedArray[i][5] == 0)) {
          $(this).find('.card-header td').eq(2).children('b').text('-\xA5' + String(parsedArray[i][4]).replace('-', '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
          total = total - Number(parsedArray[i][4]);
        } else if ((parsedArray[i][4] == 0) && (parsedArray[i][5] >= 0)) {
          $(this).find('.card-header td').eq(2).children('b').text('\xA5' + String(parsedArray[i][5]).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
          total = total + Number(parsedArray[i][5]);
        }
        $(this).find('.details tr').eq(0).children('td').eq(2).text(parsedArray[i][2]);
        $(this).find('.details tr').eq(1).children('td').eq(2).text(parsedArray[i][6]);
        $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(0).text(parsedArray[i][7]);
        $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(1).text(parsedArray[i][8]);
        $(this).find('.details tr').eq(3).children('td').eq(2).text(parsedArray[i][9]);
      };
    })(i)
  );
}
});

for (var i=0; i<testArray1.length; i++) {
  $('.dropdown .list-group').append('<li class="list-group-item custom"><a class="collapsed text-body" data-toggle="collapse" role="button" aria-expanded="false"></a></li>');
  $('.dropdown .list-group-item').eq(i).attr('value', testArray1[i][0]);
  $('.dropdown .collapse a[data-toggle="collapse"]').eq(i).text(testArray1[i][0]);
  $('.dropdown .collapse a[data-toggle="collapse"]').eq(i).attr('href', '#collapseDD' + String(i));
  $('.dropdown .collapse a[data-toggle="collapse"]').eq(i).attr('aria-controls', 'collapseDD' + String(i));
}
    var hiddenItemNo = 0;
    var visibleItem = $('.dropdown .card-header a[data-toggle="collapse"]');
    var selectItem = $('.dropdown .list-group-item').eq(hiddenItemNo);
    visibleItem.text(selectItem.attr('value'));
    selectItem.hide();
    if (testArray1[hiddenItemNo][1] < 0) {
      $('.balance-list td b').text("-\xA5" + String(testArray1[hiddenItemNo][1]).replace('-', '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
    } else {
      $('.balance-list td b').text("\xA5" + String(testArray1[hiddenItemNo][1]).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
    }
}, false);

  $(function(){
    $('.dropdown .list-group-item').click(function(){

/* $( selector [ , context ] ) */
/* セレクター文字列を指定して、マッチした要素群のjQueryオブジェクトを返します。 */
/* selector 要素を特定するセレクター文字列を指定します。 */
/* context contextにDOM要素、document、jQueryオブジェクト等を指定することで、selectorはcontexに指定されたものの中から、要素を特定するようになります。 */
/* $('div.foo').click(function() { */
/*   $('span', this).addClass('bar'); */
/* }); */
/* contextにthisを指定することで、this(div.foo)要素内のspanを対象としています。 */

      $('.list-group-item', $(this).closest('.dropdown')).show();
      var hiddenItemNo = $('.list-group-item', $(this).closest('.dropdown')).index(this);
      var visibleItem = $('.card .card-header a[data-toggle="collapse"]', $(this).closest('.dropdown'));
      visibleItem.text($(this).attr('value'));
      $(this).hide();
      if (testArray1[hiddenItemNo][1] < 0) {
        $('.balance-list td b').text("-\xA5" + String(testArray1[hiddenItemNo][1]).replace('-', '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
      } else {
        $('.balance-list td b').text("\xA5" + String(testArray1[hiddenItemNo][1]).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
      }
    });
  });

  $(function(){
    $('.dropdown .list-group-item').click(function(){
      var visibleItem = $('.collapse', $(this).closest('.dropdown'));
      visibleItem.collapse('hide');
    });
  });

  $(function(){
    /* この記述でないと動的追加要素に作用しない */
    $('#target').on('click', '.btn-outline-secondary', function(){
      $(this).closest('.card-body').children('#target-addform').before('<hr>');
      $(this).closest('.card-body').children('#target-addform')
        .load('template2.html', null, function(){
        /* 日付 */
          $(this).closest('.card-body').find('.edit-form tr').eq(0).find('input')
            /* 複数個所へ反映させるには'<文字列>'ではなく/<文字列>/gで指定 */
            .val($(('.card-header'), $(this).closest('.card')).find('.text-body td').eq(0).text().replace(/\//g, ''));
        /* 分類 */
          $(this).closest('.card-body').find('.edit-form tr').eq(1).find('input')
            .val($(this).closest('.card-body').find('.details tr').eq(0).children('td').eq(2).text());
        /* 項目 */
          $(this).closest('.card-body').find('.edit-form tr').eq(2).find('input')
            .val($(('.card-header'), $(this).closest('.card')).find('.text-body td').eq(1).text());
        /* 支出／収入 */
          $(this).closest('.card-body').find('.edit-form tr').eq(3).find('input')
            .val($(('.card-header'), $(this).closest('.card')).find('.text-body td').eq(2).text().replace('\xA5', '').replace(',', ''));
        /* 種類 */
          $(this).closest('.card-body').find('.edit-form tr').eq(4).find('input')
            .val($(this).closest('.card-body').find('.details tr').eq(1).children('td').eq(2).text());
        /* 費目 */
          $(this).closest('.card-body').find('.edit-form tr').eq(5).find('input')
            .val($(this).closest('.card-body').find('.details tr').eq(2).children('td').eq(2).children('span').eq(0).text());
        /* 内訳 */
          $(this).closest('.card-body').find('.edit-form tr').eq(6).find('input')
            .val($(this).closest('.card-body').find('.details tr').eq(2).children('td').eq(2).children('span').eq(1).text());
        /* 口座 */
          $(this).closest('.card-body').find('.edit-form tr').eq(7).find('input')
            .val($(this).closest('.card-body').find('.details tr').eq(3).children('td').eq(2).text());
      });
      $(this).text('適用');
      $(this).removeClass('btn-outline-secondary');
      $(this).addClass('btn-secondary');
    });
  });

  $(function(){
    /* この記述でないと動的追加要素に作用しない */
    $('#target').on('click', '.btn-secondary', function(){
      $(this).closest('.card').map(function(){
        /* 日付 */
        if (($(this).find('.edit-form tr').eq(0).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(0).find('input').val() != $(this).find('.card-header td').eq(0).text().replace(/\//g, ''))) {
            $(this).find('.card-header td').eq(0).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.card-header td').eq(0).text($(this).find('.edit-form tr').eq(0).find('input').val()
            .replace(/(\d{4})(\d{2})(\d{2})/g, '$1/$2/$3'));
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */
        /* 分類 */
        if (($(this).find('.edit-form tr').eq(1).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(1).find('input').val() != $(this).find('.details tr').eq(0).children('td').eq(2).text())) {
            $(this).find('.details tr').eq(0).children('td').eq(2).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.details tr').eq(0).children('td').eq(2).text($(this).find('.edit-form tr').eq(1).find('input').val());
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */
        /* 項目 */
        if (($(this).find('.edit-form tr').eq(2).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(2).find('input').val() != $(this).find('.card-header td').eq(1).text())) {
            $(this).find('.card-header td').eq(1).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.card-header td').eq(1).text($(this).find('.edit-form tr').eq(2).find('input').val());
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */
        /* 支出／収入 */
        if (($(this).find('.edit-form tr').eq(3).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(3).find('input').val() != $(this).find('.card-header td').eq(2).text().replace('\xA5', '').replace(',', ''))) {
            $(this).find('.card-header td').eq(2).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          if (Number($(this).find('.edit-form tr').eq(3).find('input').val()) < 0) {
            $(this).find('.card-header td').eq(2).text("-\xA5" + $(this).find('.edit-form tr').eq(3).find('input').val()
              .replace('-', '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
          } else {
            $(this).find('.card-header td').eq(2).text("\xA5" + $(this).find('.edit-form tr').eq(3).find('input').val()
              .replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,'));
          }
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */
        /* 種類 */
        if (($(this).find('.edit-form tr').eq(4).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(4).find('input').val() != $(this).find('.details tr').eq(1).children('td').eq(2).text())) {
            $(this).find('.details tr').eq(1).children('td').eq(2).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.details tr').eq(1).children('td').eq(2).text($(this).find('.edit-form tr').eq(4).find('input').val());
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */

        /* 費目 */
        if (($(this).find('.edit-form tr').eq(5).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(5).find('input').val() != $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(0).text())) {
            $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(0).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(0).text($(this).find('.edit-form tr').eq(5).find('input').val());
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */

        /* 内訳 */
        if (($(this).find('.edit-form tr').eq(6).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(6).find('input').val() != $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(1).text())) {
            $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(1).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.details tr').eq(2).children('td').eq(2).children('span').eq(1).text($(this).find('.edit-form tr').eq(6).find('input').val());
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */

        /* 口座 */
        if (($(this).find('.edit-form tr').eq(7).find('input').val() != '')
          && ($(this).find('.edit-form tr').eq(7).find('input').val() != $(this).find('.details tr').eq(3).children('td').eq(2).text())) {
            $(this).find('.details tr').eq(3).children('td').eq(2).css({
              'font-weight': 'bold',
              'color': 'red'
            });
          $(this).find('.details tr').eq(3).children('td').eq(2).text($(this).find('.edit-form tr').eq(7).find('input').val());
          if ($(this).closest('.card').parent().attr('data-modified') == 'false') {
            $(this).closest('.card').parent().attr('data-modified', 'true');
          }
        }
        /*  */
      });
      $(this).closest('.card-body').find('hr').remove();
      $(this).closest('.card-body').find('.edit-form').remove();
      $(this).text('編集');
      $(this).removeClass('btn-secondary');
      $(this).addClass('btn-outline-secondary');
    });
  });

  $(function(){
    $('.linkTest').click(function(){
	getJSON();
    });
  });

  $(function(){
    $('#target').on('click', '.btn-danger', function(){
      if(confirm('本当に削除しますか？')){
        $('.card-header', $(this).closest('.card')).addClass('bg-warning');
        $(this).closest('.card').parent().attr('data-deleted', 'true');
        $(this).text('削除取消');
        $(this).removeClass('btn-danger');
        $(this).addClass('btn-success');
        alert('削除しました');
      }else{
        return 'false';
      }
    });
  });

  $(function(){
    $('#target').on('click', '.btn-success', function(){
      if(confirm('削除を取り消しますか？')){
        $('.card-header', $(this).closest('.card')).removeClass('bg-warning');
        $(this).closest('.card').parent().attr('data-deleted', 'false');
        $(this).text('削除');
        $(this).removeClass('btn-success');
        $(this).addClass('btn-danger');
        alert('削除を取り消しました');
      }else{
        return 'false';
      }
    });
  });

</script>

<style type="text/css">
<!--

/* 先にインラインテーブル化必須 */
.accordion .card .card-body .details,
.accordion .card .card-body .btn-grp {
  display: inline-table;
  vertical-align: middle;
}

.accordion .card .card-header,
.accordion .card .card-body,
.dropdown .card .card-header,
.dropdown .card .list-group-item {
  padding: 0 0 0 0;
  margin: 0 0 0 0;
}

.accordion .card .card-header td,
.accordion .card .card-body td,
.accordion .card .card-body td .btn,
.dropdown .card .card-header,
.dropdown .card .list-group-item,
.accordion .category td,
.accordion .category.total td,
.balance-list td,
.balance-list th,
.searchForm .card .card-header,
.linkTest {
  font-size: 14px;
}

.accordion .td-03 {
  background: #cfe6ff;
}

.accordion,
.dropdown .card a[data-toggle="collapse"],
.searchForm .card a[data-toggle="collapse"],
.linkTest {
  display: block;
}

.accordion .card .card-header a[data-toggle="collapse"]:active,
.accordion .card .card-header a[data-toggle="collapse"]:hover,
.accordion .card .card-header a[data-toggle="collapse"]:focus,
.dropdown .card a[data-toggle="collapse"]:active,
.dropdown .card a[data-toggle="collapse"]:hover,
.dropdown .card a[data-toggle="collapse"]:focus,
.searchForm .card a[data-toggle="collapse"]:active,
.searchForm .card a[data-toggle="collapse"]:hover,
.searchForm .card a[data-toggle="collapse"]:focus {
  text-decoration: none; //リンクテキストの下線を消す
}

.dropdown .card .list-group .custom {
  border: none;
}

.balance-list table {
  width:100%;
}

.balance-list td,
.balance-list th {
  border-left: solid 1px #bbb;
  border-top: solid 1px #bbb;
  border-right: solid 1px #bbb;
  border-bottom: solid 1px #bbb;
}

.balance-list .td-03 {
  background: #cfe6ff;
  text-align:center;
}

/* 先にfixed指定がないと次が効かない */
#target .text-body table {
  table-layout: fixed;
}

#target .text-body td:nth-child(2) {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.accordion .category,
.balance-list td {
  background-color: #ffffff;
}

-->
</style>

</head>

<body>

<div class="accordion" id="accordion" role="tablist" aria-multiselectable="true">

<div class="sticky-top">

<div class="mb-0 category">
  <table width="100%">
    <tr>
      <td width="100%"><b>口座</b></td>
    </tr>
  </table>
</div>

<div class="dropdown" id="dropdown" role="tablist" aria-multiselectable="true">
<div class="card">
  <div class="card-header" role="tab" id="collapseListGroupHeading1">
    <div class="mb-0">
      <a href="#collapseListGroup1" class="text-body" role="button" data-toggle="collapse" aria-expanded="false" aria-controls="collapseListGroup1">
        項目を選択してください
      </a>
    </div>
  </div>
  <div class="collapse" role="tabpanel" id="collapseListGroup1" aria-labelledby="collapseListGroupHeading1" aria-expanded="false">
    <ul class="list-group list-group-flush">
    </ul>
    </div>
</div>
</div>

<div class="balance-list">
 <table>
    <tbody>
    <tr>
    <th class="td-03">現在の残高</th>
    </tr>
    <tr>
    <td align="right"><b></b></td>
    </tr>
    </tbody>
 </table>

</div>

<div class="searchForm" id="searchForm" role="tablist" aria-multiselectable="true">
  <div class="card">
    <div class="card-header" role="tab" id="collapseListGroupHeading2">
      <div class="mb-0">
        <a href="#collapseListGroup2" class="text-body" role="button" data-toggle="collapse" aria-expanded="false" aria-controls="collapseListGroup2">
          詳細検索
        </a>
      </div>
    </div>
    <div id="collapseListGroup2" class="collapse" role="tabpanel" aria-labelledby="collapseListGroupHeading2">
      <div class="card-body">
        【検索フォームを置く】
      </div><!-- /.card-body -->
    </div><!-- /.collapse -->
  </div><!-- /.card -->
</div>

<div class="mb-0 category total">
  <table width="100%">
    <tr>
      <td width="50%"><b>支出一覧</b></td>
      <td width="50%" align="right"><font color="red"><b>支出総額　　<span></span></b></font></td>
    </tr>
  </table>
</div>

  <div class="card td-03">
    <div class="card-header">
      <div class="mb-0">
          <table class="btn01" width="100%">
            <tr>
              <td width="30%"><b>日付</b></td>
              <td width="40%"><b>項目</b></td>
              <td><b>支出／収入</b></td>
            </tr>
          </table>
      </div>
    </div><!-- /.card-header -->
  </div><!-- /.card -->

</div><!-- /.sticky-top -->

<div id="target">

</div><!-- /target -->

</div><!-- /accordion -->

<div class="linkTest">
  <a>テスト</a>
</div>

</body>

</html>